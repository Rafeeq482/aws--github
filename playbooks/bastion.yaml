---
- name: ğŸ” Verify Bastion Key and Test SSH Access
  hosts: localhost
  gather_facts: false
  tasks:

    - name: ğŸ” Show permissions on injected SSH keys
      ansible.builtin.command: ls -l /runner/env/
      register: key_perms

    - name: ğŸ“‹ Show PEM key permissions
      ansible.builtin.debug:
        var: key_perms.stdout_lines

    - name: ğŸ”§ Ensure bastion PEM key has correct permissions
      ansible.builtin.file:
        path: /runner/env/template.ssh_key_bastion
        mode: '0600'

    - name: ğŸ” Check Bastion Reachability
      ansible.builtin.command: >
        ssh -i /runner/env/template.ssh_key_bastion
        -o StrictHostKeyChecking=no
        ubuntu@65.2.190.68 "echo 'âœ… Bastion OK'"
      register: bastion_check
      ignore_errors: true

    - name: ğŸ’¬ Show Bastion Response
      ansible.builtin.debug:
        msg: |
          {% if bastion_check.rc == 0 %}
          SUCCESS: {{ bastion_check.stdout }}
          {% else %}
          âŒ SSH to Bastion Failed:
          {{ bastion_check.stderr }}
          {% endif %}
