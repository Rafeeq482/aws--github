---
- name: ğŸ” Verify Bastion Key and Test SSH Access (No Sudo)
  hosts: localhost
  gather_facts: false
  connection: local
  tasks:

    - name: ğŸ‘¤ Who am I running as?
      ansible.builtin.command: whoami
      register: whoami_result

    - name: ğŸ§¾ Current user
      ansible.builtin.debug:
        var: whoami_result.stdout

    - name: ğŸ“ List injected SSH keys
      ansible.builtin.command: ls -l /runner/env/
      register: key_perms

    - name: ğŸ“‹ Show PEM key permissions
      ansible.builtin.debug:
        var: key_perms.stdout_lines

    - name: ğŸ”§ Fix PEM permissions without sudo
      ansible.builtin.shell: chmod 600 /runner/env/template.ssh_key_bastion

    - name: ğŸ” Check Bastion Reachability
      ansible.builtin.command: >
        ssh -i /runner/env/template.ssh_key_bastion
        -o StrictHostKeyChecking=no
        ubuntu@65.2.190.68 "echo 'âœ… Bastion OK'"
      register: bastion_check
      ignore_errors: true

    - name: ğŸ’¬ Show Bastion Response
      ansible.builtin.debug:
        msg: |
          {% if bastion_check.rc == 0 %}
          âœ… SUCCESS: {{ bastion_check.stdout }}
          {% else %}
          âŒ SSH to Bastion Failed:
          {{ bastion_check.stderr }}
          {% endif %}
