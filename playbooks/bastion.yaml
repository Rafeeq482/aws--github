---
- name: 🔐 Test Bastion SSH (No sudo)
  hosts: localhost
  gather_facts: false
  connection: local
  become: false

  tasks:

    - name: 👤 Who am I running as?
      ansible.builtin.command: whoami
      register: whoami_result

    - name: 🧾 Show current user
      ansible.builtin.debug:
        msg: "{{ whoami_result.stdout }}"

    - name: 🧪 List files in /runner/env/
      ansible.builtin.command: ls -l /runner/env/
      register: env_files

    - name: 🔍 Show files in /runner/env/
      ansible.builtin.debug:
        var: env_files.stdout_lines

    - name: 📄 Write bastion PEM from env
      copy:
        content: "{{ lookup('env', 'BASTION_PEM_KEY') | replace('\\n', '\n') }}"
        dest: /tmp/bastion.pem
        mode: '0600'

    - name: 📁 List files in /tmp to confirm PEM creation
      command: ls -l /tmp
      register: tmp_files

    - name: 🪵 Show /tmp PEM file listing
      debug:
        var: tmp_files.stdout_lines

    - name: 🧪 Test Bastion SSH
      shell: >
        ssh -i /tmp/bastion.pem
        -o StrictHostKeyChecking=no
        ubuntu@65.2.190.68 "echo '✅ Connected to Bastion'"
      register: ssh_result
      ignore_errors: true

    - name: 🪵 Show SSH test result
      debug:
        msg: |
          {% if ssh_result.rc == 0 %}
          ✅ Success: {{ ssh_result.stdout }}
          {% else %}
          ❌ Failed: {{ ssh_result.stderr }}
          {% endif %}
