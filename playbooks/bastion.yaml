---
- name: ğŸ” Test Bastion SSH (No sudo)
  hosts: localhost
  gather_facts: false
  connection: local
  become: false

  tasks:

    - name: ğŸ‘¤ Who am I running as?
      ansible.builtin.command: whoami
      register: whoami_result

    - name: ğŸ§¾ Show current user
      ansible.builtin.debug:
        msg: "{{ whoami_result.stdout }}"

    - name: ğŸ§ª List files in /runner/env/
      ansible.builtin.command: ls -l /runner/env/
      register: env_files

    - name: ğŸ” Show files in /runner/env/
      ansible.builtin.debug:
        var: env_files.stdout_lines

    - name: ğŸ”§ Fix permission for bastion key (no sudo)
      ansible.builtin.command: chmod 600 /runner/env/template.ssh_key_bastion
      register: chmod_result
      ignore_errors: true

    - name: ğŸªµ Show chmod result
      ansible.builtin.debug:
        msg: |
          {% if chmod_result.rc == 0 %}
          âœ… chmod success
          {% else %}
          âŒ chmod failed: {{ chmod_result.stderr }}
          {% endif %}

    - name: ğŸ§ª Test Bastion SSH
      ansible.builtin.shell: >
        ssh -i /runner/env/template.ssh_key_bastion
        -o StrictHostKeyChecking=no
        ubuntu@65.2.190.68 "echo 'âœ… Connected to Bastion'"
      register: ssh_result
      ignore_errors: true

    - name: ğŸªµ Show SSH test result
      ansible.builtin.debug:
        msg: |
          {% if ssh_result.rc == 0 %}
          âœ… Success: {{ ssh_result.stdout }}
          {% else %}
          âŒ Failed: {{ ssh_result.stderr }}
          {% endif %}
